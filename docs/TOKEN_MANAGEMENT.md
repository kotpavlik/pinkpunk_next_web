# üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ —Å–µ—Å—Å–∏—è–º–∏ v2.0

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π](#–æ–±–∑–æ—Ä-–∏–∑–º–µ–Ω–µ–Ω–∏–π)
2. [–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–∫–µ–Ω–æ–≤](#–ø–∞—Ä–∞–º–µ—Ç—Ä—ã-—Ç–æ–∫–µ–Ω–æ–≤)
3. [–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#–∫–ª—é—á–µ–≤—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)
4. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
5. [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
6. [–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-—Å–æ–±—ã—Ç–∏–π)
7. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

---

## üéØ –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ß—Ç–æ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ (v1.0):

- ‚ùå –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ `alert()` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚ùå –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π `window.location.reload()` –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞
- ‚ùå –¢–æ–∫–µ–Ω—ã –æ—á–∏—â–∞–ª–∏—Å—å –ø—Ä–∏ –õ–Æ–ë–û–ô –æ—à–∏–±–∫–µ (–¥–∞–∂–µ —Å–µ—Ç–µ–≤–æ–π)
- ‚ùå –ù–µ—Ç retry-–ª–æ–≥–∏–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö
- ‚ùå –ë—É—Ñ–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è 5 –º–∏–Ω—É—Ç
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–∞—Å—Ç–æ –≤—ã–∫–∏–¥—ã–≤–∞–ª–æ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è

### –ß—Ç–æ —Å—Ç–∞–ª–æ (v2.0):

- ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–µ –Ω–µ–∏–Ω–≤–∞–∑–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –ü–ª–∞–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–±–µ–∑ reload)
- ‚úÖ –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ vs –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (–¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω –±—É—Ñ–µ—Ä –¥–æ 10 –º–∏–Ω—É—Ç
- ‚úÖ –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ Event-driven —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–∫–µ–Ω–æ–≤

### –û—Ç –±—ç–∫–µ–Ω–¥–∞:

```typescript
accessToken (JWT):
  - –§–æ—Ä–º–∞—Ç: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 1 —á–∞—Å (3600 —Å–µ–∫—É–Ω–¥)
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: Authorization header –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤

refreshToken:
  - –§–æ—Ä–º–∞—Ç: hex —Å—Ç—Ä–æ–∫–∞ (64 —Å–∏–º–≤–æ–ª–∞)
  - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 30 –¥–Ω–µ–π
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ accessToken —á–µ—Ä–µ–∑ /auth/refresh
```

### –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

- **TOKEN_REFRESH_BUFFER**: 10 –º–∏–Ω—É—Ç
  - –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
  - –ü—Ä–∏ —Ç–æ–∫–µ–Ω–µ –Ω–∞ 60 –º–∏–Ω—É—Ç, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –Ω–∞ 50-–π –º–∏–Ω—É—Ç–µ

- **MAX_RETRY_ATTEMPTS**: 3 –ø–æ–ø—ã—Ç–∫–∏
  - –ü—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö —Å–∏—Å—Ç–µ–º–∞ –¥–µ–ª–∞–µ—Ç –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫

- **RETRY_BASE_DELAY**: 1 —Å–µ–∫—É–Ω–¥–∞
  - –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

- **RETRY_MAX_DELAY**: 10 —Å–µ–∫—É–Ω–¥
  - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (—Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º —Ä–æ—Å—Ç–æ–º)

---

## üöÄ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```typescript
// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (401) - –æ—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤:
- "Session expired"
- "No active sessions"
- "Telegram authentication expired"
- "Invalid refresh token"

// –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ - retry –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏:
- –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
- –û—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (5xx)
- –¢–∞–π–º–∞—É—Ç—ã
```

### 2. Retry-–ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

```typescript
–ü–æ–ø—ã—Ç–∫–∞ 1: —Å—Ä–∞–∑—É
–ü–æ–ø—ã—Ç–∫–∞ 2: —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
–ü–æ–ø—ã—Ç–∫–∞ 3: —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
–ü–æ–ø—ã—Ç–∫–∞ 4: —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã (–µ—Å–ª–∏ –º–∞–∫—Å. < 10 —Å–µ–∫)
```

### 3. –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```typescript
// –¢–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
tokenManager.saveTokens(data) ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä
```

### 4. Event-—Å–∏—Å—Ç–µ–º–∞

```typescript
export type TokenEventType = 
    | 'TOKEN_EXPIRED'           // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫
    | 'TOKEN_REFRESHED'         // –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    | 'TOKEN_REFRESH_FAILED'    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞
    | 'SESSION_EXPIRED'         // –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞
    | 'TELEGRAM_AUTH_EXPIRED'   // Telegram auth —É—Å—Ç–∞—Ä–µ–ª
    | 'NETWORK_ERROR';          // –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –§–∞–π–ª—ã:

```
src/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ TokenManager.ts              # –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ components/ui/shared/
‚îÇ   ‚îî‚îÄ‚îÄ TokenEventHandler.tsx        # UI –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π
‚îî‚îÄ‚îÄ app/
    ‚îî‚îÄ‚îÄ layout.tsx                   # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:

```mermaid
graph TD
    A[API –∑–∞–ø—Ä–æ—Å] --> B{–¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω?}
    B -->|–ù–µ—Ç| C[TokenManager.refreshAccessToken]
    C --> D{Refresh —É—Å–ø–µ—à–µ–Ω?}
    D -->|–î–∞| E[Emit: TOKEN_REFRESHED]
    D -->|–ù–µ—Ç| F{–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞?}
    F -->|–î–∞| G[Retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π]
    G --> C
    F -->|–ù–µ—Ç| H[Emit: SESSION_EXPIRED]
    E --> I[TokenEventHandler]
    H --> I
    I --> J[–ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]
    B -->|–î–∞| K[–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–ø—Ä–æ—Å]
```

---

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. TokenManager (utils/TokenManager.ts)

#### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

```typescript
// –ü–æ–ª—É—á–∏—Ç—å access token (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º refresh)
const token = await tokenManager.getAccessToken()

// –ü–æ–ª—É—á–∏—Ç—å token –±–µ–∑ refresh (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
const token = tokenManager.getAccessTokenSync()

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
tokenManager.saveTokens({
    accessToken: 'eyJ...',
    refreshToken: 'a1b2c3...',
    expiresIn: 3600
})

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
const isAuth = tokenManager.isAuthenticated()

// –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
tokenManager.clearTokens()

// –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
const unsubscribe = tokenManager.addEventListener((event, data) => {
    console.log('Token event:', event, data)
})
```

#### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:

```typescript
// –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (–º—Å)
const timeLeft = tokenManager.getTimeUntilExpiry()

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏–¥–µ—Ç –ª–∏ —Å–µ–π—á–∞—Å refresh
const isRefreshing = tokenManager.isCurrentlyRefreshing()
```

### 2. TokenEventHandler (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `app/layout.tsx`:

```tsx
import TokenEventHandler from '@/components/ui/shared/TokenEventHandler'

export default function RootLayout({ children }) {
    return (
        <html>
            <body>
                <TokenEventHandler />  {/* ‚Üê –ó–¥–µ—Å—å */}
                <Header />
                {children}
                <Footer />
            </body>
        </html>
    )
}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥

### 3. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ

```tsx
'use client'

import { useEffect, useState } from 'react'
import { tokenManager } from '@/utils/TokenManager'

export default function MyComponent() {
    const [user, setUser] = useState(null)

    useEffect(() => {
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è —Ç–æ–∫–µ–Ω–æ–≤
        const unsubscribe = tokenManager.addEventListener((event) => {
            if (event === 'SESSION_EXPIRED') {
                // –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                setUser(null)
            } else if (event === 'TOKEN_REFRESHED') {
                // –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω, –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å
                console.log('Token refreshed in background')
            }
        })

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const loadUser = async () => {
            const token = await tokenManager.getAccessToken()
            if (token) {
                // –î–µ–ª–∞–µ–º API –∑–∞–ø—Ä–æ—Å
                const response = await fetch('/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                const userData = await response.json()
                setUser(userData)
            }
        }

        loadUser()

        return () => unsubscribe()
    }, [])

    return <div>{/* ... */}</div>
}
```

---

## üé® –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

#### 1. INFO (—Å–∏–Ω–∏–π) - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ

```typescript
'TOKEN_REFRESHED'
‚Üí –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–°–µ—Å—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ: "–í–∞—à–∞ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∞"
‚Üí –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ: —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
```

#### 2. WARNING (–∂–µ–ª—Ç—ã–π) - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

```typescript
'TOKEN_REFRESH_FAILED'
‚Üí –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º"
‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é, –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É..."
‚Üí –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ: —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥

'NETWORK_ERROR'
‚Üí –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"
‚Üí –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ: —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
```

#### 3. ERROR (–∫—Ä–∞—Å–Ω—ã–π) - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ

```typescript
'SESSION_EXPIRED'
‚Üí –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞"
‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ: "–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ..."
‚Üí –ö–Ω–æ–ø–∫–∞: "–í–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ"
‚Üí –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ: –ù–ï–¢ (—Ç—Ä–µ–±—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

'TELEGRAM_AUTH_EXPIRED'
‚Üí –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ: "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Telegram –∏—Å—Ç–µ–∫–ª–∞ (15 –¥–Ω–µ–π)..."
‚Üí –ö–Ω–æ–ø–∫–∞: "–í–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ"
‚Üí –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ: –ù–ï–¢

'TOKEN_EXPIRED'
‚Üí –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ"
‚Üí –ö–Ω–æ–ø–∫–∞: "–í–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ"
‚Üí –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ: –ù–ï–¢
```

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ DO (–î–µ–ª–∞–π—Ç–µ —Ç–∞–∫):

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `getAccessToken()` –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤**
   ```typescript
   const token = await tokenManager.getAccessToken()
   // –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
   ```

2. **–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è**
   ```typescript
   useEffect(() => {
       const unsubscribe = tokenManager.addEventListener((event) => {
           // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è
       })
       return () => unsubscribe()
   }, [])
   ```

3. **–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ç–æ–∫–µ–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
   ```typescript
   tokenManager.saveTokens({
       accessToken,
       refreshToken,
       expiresIn
   })
   // –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   ```

4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `TokenEventHandler` –≤ layout**
   - –£–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `app/layout.tsx`
   - –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö

### ‚ùå DON'T (–ù–µ –¥–µ–ª–∞–π—Ç–µ —Ç–∞–∫):

1. **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `alert()` –¥–ª—è –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
   ```typescript
   // ‚ùå –ü–ª–æ—Ö–æ
   if (!token) {
       alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')
   }

   // ‚úÖ –•–æ—Ä–æ—à–æ
   if (!token) {
       // TokenEventHandler –ø–æ–∫–∞–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   }
   ```

2. **–ù–ï –¥–µ–ª–∞–π—Ç–µ `window.location.reload()` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö**
   ```typescript
   // ‚ùå –ü–ª–æ—Ö–æ
   if (error.status === 401) {
       window.location.reload()
   }

   // ‚úÖ –•–æ—Ä–æ—à–æ
   if (error.status === 401) {
       // TokenManager —Å–∞–º –ø–æ–ø—Ä–æ–±—É–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
       // TokenEventHandler –ø–æ–∫–∞–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞—Å—Ç—Å—è
   }
   ```

3. **–ù–ï –æ—á–∏—â–∞–π—Ç–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö**
   ```typescript
   // ‚ùå –ü–ª–æ—Ö–æ
   try {
       await api.call()
   } catch (error) {
       tokenManager.clearTokens() // –î–∞–∂–µ –ø—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ!
   }

   // ‚úÖ –•–æ—Ä–æ—à–æ
   try {
       await api.call()
   } catch (error) {
       // TokenManager —Å–∞–º —Ä–µ—à–∏—Ç, –Ω—É–∂–Ω–æ –ª–∏ –æ—á–∏—â–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
   }
   ```

4. **–ù–ï –¥–µ–ª–∞–π—Ç–µ —Ä—É—á–Ω–æ–π refresh –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏**
   ```typescript
   // ‚ùå –ü–ª–æ—Ö–æ
   if (tokenManager.isAccessTokenExpired()) {
       await tokenManager.refreshAccessToken()
   }

   // ‚úÖ –•–æ—Ä–æ—à–æ
   const token = await tokenManager.getAccessToken()
   // Refresh –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
   ```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

TokenManager –∞–∫—Ç–∏–≤–Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è:

```typescript
console.log('üíæ Tokens saved successfully')
console.log('‚è∞ Background refresh scheduled in X minutes')
console.log('üîÑ Refresh attempt 1/3')
console.log('‚úÖ Tokens refreshed successfully')
console.log('üö® Critical auth error, stopping retry')
console.log('‚ùå All refresh attempts failed')
console.log('üîî Token Event: SESSION_EXPIRED')
console.log('üóëÔ∏è Tokens cleared')
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:

```typescript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
tokenManager.isAuthenticated()
tokenManager.getTimeUntilExpiry() / 1000 / 60 // –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
tokenManager.isCurrentlyRefreshing()
```

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –£–ª—É—á—à–µ–Ω–∏—è UX:

- ‚úÖ **–ù–µ—Ç –≤–Ω–µ–∑–∞–ø–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫** - –ø–ª–∞–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ **–ú–µ–Ω—å—à–µ —Ä–∞–∑—Ä—ã–≤–æ–≤ —Å–µ—Å—Å–∏–∏** - retry-–ª–æ–≥–∏–∫–∞ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å–±–æ—è–º–∏
- ‚úÖ **–§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ **–ö—Ä–∞—Å–∏–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –≤–º–µ—Å—Ç–æ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö alert()
- ‚úÖ **–£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - —Ä–∞–∑–ª–∏—á–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- ‚úÖ **Event-driven** - –ª–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –ª—é–±–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- ‚úÖ **Decoupled** - UI –æ—Ç–¥–µ–ª–µ–Ω –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- ‚úÖ **Resilient** - —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–µ—Ç–µ–≤—ã–º —Å–±–æ—è–º
- ‚úÖ **Observable** - –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ **Maintainable** - —á–∏—Å—Ç—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `TokenEventHandler` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `layout.tsx`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–±—ã—Ç–∏—è –≤ DevTools ‚Üí Application ‚Üí Local Storage

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 2.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-11-20  
**–ê–≤—Ç–æ—Ä:** Pink Punk Development Team

